# Ivestment MOEX
# CODE FOR PYTHONANYWHERE DEPLOYMENT
## Video Demo:  https://youtu.be/HZUL9YLb3X0
## Web site:  https://lastrole.pythonanywhere.com
## Source code: https://github.com/la-strole/moex

## Цель проекта:
1. Образовательная игра, дающая возможность пользователям попробовать свои силы в инвестировании, используя API московской биржи;
2. Личный инвестиционный планировщик, хранит ваш портфель, рассчитывает его текущую стоимость, уведомляет письмом о выходе рыночных цен на ценные бумаги портфеля за заданные границы.
3. Планируется: 
   1. Добавить API для получения текущих данных по ценным бумагам для удобного взаимодействия с таблицами google, open office, microsoft excel;
   2. Использовать исходный код, эмулирующий операции купли/продажи по текущим биржевым ценам для тестирования торговых роботов.
## Реализация:
Приложение эмулирует работу типичного брокера:
1. Создает для пользователя виртуальный депозитарный счет и учитывает на нем текущие ценные бумаги. Производит оценку портфеля в текущих ценах активов на московской бирже;
2. Создает для пользователя виртуальный брокерский счет и учитывает на нем операции купли-продажи ценных бумаг, а при совершении операций с ценными бумагами, номинированными в валюте, производит конвертирование в рубли реальному текущему биржевому курсу московской биржи в момент совершения сделки;
3. Дает возможность искать, получать исчерпывающую текущую информацию по ценным бумагам (акциям, облигациям, etf, иностранным акциям) по всем доступным инструментам фондового рынка московской биржи (в настоящее время более 3400 наименований);
4.  Дает возможность совершать виртуальные сделки купли-продажи по реальным текущим биржевым ценам (в момент "совершения сделки" получаются данные "стакана" биржи по инструменту);
5.  Таким образом, пользователь может попробовать себя в роли инвестора, трейдера, получая реальную текущую информацию по инструментам (правда, с 15 минутной задержкой - см. Ограничения) и будет подготовлен к работе с любым реальным брокером.

## Требования:
1. Интернет. Поддержка java script в браузере.

## Ограничения:
1. В настоящее время API мосбиржи на бесплатном аккаунте выдает данные по текущим ценам купли-продажи с задержкой в 15 минут. Таким образом использование приложения для трейдинга имеет некоторые ограничения по сравнению с коммерческими продуктами, купившими лицензию мосбиржи на отображение информации в реальном времени;
2. Ограничения хостинга pythonanywhere.com для бесплатного аккаунта дают возможность выполнять запланированные задачи на сервере не чаще раза в сутки. Таким образом уведомления о превышении ценовых границ и проверка ценовых границ возможна только раз в сутки - и происходит в 10.30 по московскому времени.
    
## Развертывание и запуск на сервере:
1. Требования: <br>
   1. `python v3.6` или выше;
   2. Примеры кода ниже в части экспорта переменных среды описаны для ОС семейства Linux, для MS Windows или MacOS пожалуйста, используйте соответствующий синтаксис;
   3. Описан пример для запуска на локальном `FLask` сервере, для работы через `wsgi` на иных серверах следует выполнить шаги в документации к ним, учитывая, что `flask app = <путь_к_рабочему_каталогу/moex_invest>`, а настройки приложения хранятся в файле, на который указывает создаваемая переменная среды `MOEX_SANDBOX_SETTINGS`.
2. Клонируйте репозиторий в рабочий каталог:    `git clone https://github.com/la-strole/moex.git`
3. Создайте виртуальную среду: `python3 -m venv env`
4. Перейдите в созданную среду: `source ven/bin/activate`
5. Установите зависимости: `pip install requirements.txt `
6. В рабочем каталоге создайте файл `.env` следующего вида:
    ```
    # path to app configuration file to override default settings 
    export MOEX_SANDBOX_SETTINGS=<path_to_your_working_directory>/config_development.py
    # export MOEX_SANDBOX_SETTINGS=<path_to_your_working_directory>/config_production.py
   
    # path to Flask app
    export FLASK_APP=<path_to_your_working_directory>/moex_sandbox/moex_invest
   
    # to debug mode
    export FLASK_ENV=development
  
    # gmail login_password
    export mail_login='<your_mail>'
   
    export mail_password='<your_password>'
    
    ```
    Здесь:  
    1. `config_development.py` - файл с настройками Flask - уже находится в вашем каталоге. Можно ничего не менять для development mode;
    2. `config_production.py` - создайте файл с настройками для работы в production вида:<br>
        ```
        """
        Configuration for FLASK app (use it in __init__.py)
        """
        
        DATABASE = "<name_of_your_databse>"
        SECRET_KEY = "<your_secret_key>"
        DEBUG = False
        ```
    3. `FLASK_APP` - путь к каталогу с файлом  `__init__.py` - фабрике приложений;
    4. `mail_login` и `mail_password` - логин и пароль почтового ящика на gmail (что критично, так как для отправки использована библиотека yagmail, работающая только с gmail) для отправки приложением писем.<br>
   <br>
7. Добавьте переменные из `.env` в переменные среды: `source .env`
8. Проверьте, что переменная `FLASK_APP` добавлена в переменные среды: `printenv | grep FLASK`
9.  Запустите локальный `Flask` сервер: `flask run`
10. Приложение должно работать по адресу: http://127.0.0.1:5000/

В дальнейшем для запуска локального сервера будет достаточно из рабочего каталога выполнить:
1. `source <your_virtual_env>/bin/activate`
2. `source .env`
3. `flask run`
4. Приложение должно работать по адресу: http://127.0.0.1:5000/


## Работа приложения
1. При первом посещении новому пользователю необходимо зарегистрироваться и выбрать тип аккаунта - private или public.
   ![register picture](/images/register.png "Регистрация")

    **Внимание!** В дальнейшем изменить тип аккаунта будет невозможно.
    Отличия `private` и `public` аккаунтов:
    1. `Public` аккаунт используется для участия в игре - соревновании по торговле на мосбирже. Пользователь с `public` аккаунтом "получает" фиксированную сумму на "брокерский" счет в 100 000 рублей, может совершать виртуальные сделки на московской бирже, общие результаты его торговли будут видны другим пользователям с `public` аккаунтом в меню **Рейтинги**;
    2. `Private` аккаунт используется для учета личных финансов. Пользователь может самостоятельно редактировать сумму на "брокерском" счете, результаты его "торговли" не учитываются в рейтинговой таблице, не видны никому, кроме него, но он не имеет доступа к рейтинговой таблице и не может следить за статистикой пользователей с аккаунтом типа `Public`.
2. Далее пользователь попадает на главную страницу, где отображается его текущий портфель:
   ![depo picture](/images/depo.png "Депозитарий")

   Здесь `Стоимость` - текущая стоимость лучшего предложения по покупке на московской бирже, или, если предложений о покупке нет (например, инструмент не популярный или биржа закрыта) то стоимость - биржевая котировка.

   Столбец `Уведомление` появится, если пользователь указал электронную почту (указать или изменить ее можно в меню `Настройки`). Здесь можно задать минимальную и (или) максимальную границу по каждому инструменту, при выходе за которую на указанную почту пользователю (если им установлена галочка в строке с инструментом) будет отправлено предупреждающее письмо. Планировалось ежечасно проверять стоимость бумаг, которые хотели отслеживать пользователи,немедленно направлять  письмо и дублировать его, если стоимость не вернется в границы раз в сутки. Из-за реализации pythonanywhere.com это поведение пришлось изменить см. Ограничения (код доступен в репозитарии).

   В мобильной версии пункт `уведомление` возникнет в раскрывающемся меню при нажатии на стоимость, а пункт `продать` при нажатии на имя ценной бумаги.

3. Покупка/поиск:  
   
   ![quote picture](/images/quote.png "Поиск/Покупка")

   Здесь выберем тикер - наименование ценной бумаги. По мере ввода будут появляться топ 10 резульатов поиска по тексту. После нажатия на кнопку `Выбрать` Узнаем величину лота (покупка осуществляется лотами), цену за единицу и наличие предложения. <br>
   **Внимание!** Если предложения нет (тикер непопулярный, биржа закрыта) то купить ценную бумагу в данный момент вы не сможете (как и в реальной жизни).

4. Продажа: <br>
   ![sell picture](/images/sell.png "Продажа")

   Продать вы можете только ценные бумаги, на которые есть сейчас спрос и которые у вас имеются в количестве не меньше лота.

5. История: <br>
   ![history picture](/images/history.png "История")

   Тут история ваших операций по купле-продаже. Время московское `(UTC + 3)`.

6. Рейтинги: <br>
   ![rares picture](/images/rates.png "Рейтинги")

   Эта опция доступна **только** пользователям с аккаунтом `public`. Здесь видим статистику топ-10 всех пользователей с аккаунтом типа `public`.

7. Настройки: <br>
   ![settings picture](/images/settings.png "Настройки")

   Измените имя, пароль, адрес электронной почты, баланс брокерского счета (только для `private` аккаунтов). При удалении аккаунта удаляется вся информация о пользователе, включая адрес электронной почты.


## Техническая реализация приложения:
```
├── auth.py
├── db.py
├── helpers.py
├── __init__.py
├── sandbox.py
├── schedule.py
├── schema.sql
├── static
│   ├── background_large.jpg
│   ├── background_small.jpg
│   ├── favicon.ico
│   ├── logo.jpg
│   ├── logo.svg
│   ├── quote_symbols_ajax.js
│   ├── sell.js
│   └── style.css
├── templates
│    ├── auth
│    │   ├── login.html
│    │   └── register.html
│    ├── layout.html
│    └── sandbox
│        ├── depo.html
│        ├── history.html
│        ├── quote_get.html
│        ├── rates.html
│        ├── sell.html
│        └── settings.html
├── config_development.py
├── config_production.py
├── MANIFEST.in
├── README.md
├── requirements.txt
├── setup.py
└── venv
```
<br>
Использованы:<br>
1. Flask framework (jinja для генерации html);
2. sqlite в качестве СУБД;
3. Логика со стороны клиента на JS;
4. CSS framework bootstrap 5.


1. `__init__.py` - Application factory. Возвращает Flask приложение. 
   1. Настройки для базовой конфигурации Flask прописаны там и переписываются переменной среды `MOEX_SANDBOX_SETTINGS`, которая содержит ссылку на *.py файл с конфигурацией (`config_development.py` и `config_production.py`). Таким образом для изменения конфигурации необходимо либо отредактировать существующий *.py, либо создать новый и указать путь к нему в переменной среды `MOEX_SANDBOX_SETTINGS`;
   2. При инициализации приложения проверяется наличие базы данных с именем `DATABASE` из конфигурационного файла, если его нет - то база данных создается из файла `schema.sql`.
2. `db.py` - взаимодействие с БД. Зарегистрирован в `__init__.py` через ` app.teardown_appcontext()` и после каждого `request` вызывается `db.close()`.
3. `helpers.py` - служебные функции, `lookup(ticker)` - получение информации от MOEX API о ценной бумаге, `take_symbols()` - обновление списка ценных бумаг, размещенных на московской бирже для добавления в БД и подсказок при поиске/покупке через AJAX (см. `quote_symbols_ajax.js`). Также функции проверки клиентских данных из `POST request` и логирование в базу данных.
4. `sandbox.py` - основной файл реализации функций купли-продажи.  
   1. Для снижения нагрузки на базу данных получение информации о текущих параметрах ценных бумаг ДО подтверждения форм продать-купить реализуются через взаимодействие с API MOEX со стороны клиента (см `quote_symbols_ajax.js` и `sell.js`), ПОСЛЕ отправки `POST request` данные о цене тикера запрашиваются через MOEX API уже сервером (функция `helpers.lookup(ticker)`) и все операции зачисления на брокерский счет, пополнения депозитария, валютные конвертации производятся по данным, полученным сервером;
   2. Для интерактивного взаимодействия с клиентом использован `flash()` из `Flask`;
   3. Все операции логируются в базу данных в таблицу `app_log`.
5. `auth.py` - логика авторизации и аутентификации. Авторизация производится по паре - логин - пароль. Логин должен быть уникальными, хотя технически возможны и повторяющиеся - в качестве `private key` используется `user_id` - уникальный идентификатор пользователя, создаваемый автоматически при регистрации. Данные хранятся в таблице `auth` базы данных, пароль хранится в виде значения hash функции.
6. `schedule.py` - Логика отправки email с уведомлениями и ежедневного обновления списка доступных для торговли тикеров для подсказок клиенту. Как планировщик используется APShceduler (https://apscheduler.readthedocs.io/en/3.x/). Для отправки использован yagmail (https://pypi.org/project/yagmail/), что накладывает необходимость использования ящика для отправки, зарегистрированного на gmail. (Но, конечно, можно обойти это ограничение использовав другую библиотеку).
   Отправка писем:
   Ежечасно:
   1. Составление списка тикеров ценных бумаг, для которых пользователи указали границы и желание получать уведомления;
   2. Проверка текущих цен (лучшей цены покупки, если нет - биржевой котировки) на московской бирже;
   3. Формирование списка адресов email тех, цены чьих тикеров вышли за указанные ими границы;
   4. Проверка в базе данных (таблица `depo`, колонка `sent_mail`) было ли уже направлено письмо этому пользователю по этому тикеру, если да - письмо не отправляется, чтобы не раздражать пользователя ежечасными письмами.
   Раз в день:
   1. Составление списка тикеров ценных бумаг, для которых пользователи указали границы и желание получать уведомления;
   2. Проверка текущих цен (лучшей цены покупки, если нет - биржевой котировки) на московской бирже;
   3. Формирование списка адресов email тех, цены чьих тикеров вышли за указанные ими границы;
   4. Отправка писем.
   <br>
   Таким образом, пользователь получит письмо через максимум через час после выхода стоимости за границы, и, если стоимость не вернется в границы, будет получать по одному письму в день с текущими ценниками по выбранному тикеру.

7. `schema.sql` - Для автоматического создания базы данных.
   ```
   CREATE TABLE depo (
   id INTEGER PRIMARY KEY AUTOINCREMENT,
   user_id INTEGER NOT NULL,
   ticker TEXT NOT NULL,
   lotsize INTEGER NOT NULL,
   name TEXT NOT NULL,
   isqualifiedinvestors INTEGER NOT NULL,
   initialfacevalue REAL,
   number INTEGER NOT NULL,
   currency TEXT NOT NULL,
   market TEXT NOT NULL,
   min_border REAL,
   max_border REAL,
   notification TEXT,
   email_sent TEXT,
   FOREIGN KEY (user_id) REFERENCES auth (user_id)
   );
   CREATE INDEX depo_user ON depo (user_id, ticker);


   CREATE TABLE broker (
   id INTEGER PRIMARY KEY AUTOINCREMENT,
   user_id TEXT UNIQUE,
   account REAL DEFAULT 100000,
   FOREIGN KEY (user_id) REFERENCES auth (user_id)
   );
   CREATE INDEX broker_user ON broker (user_id);


   CREATE TABLE auth (
   user_id INTEGER PRIMARY KEY,
   username TEXT UNIQUE NOT NULL,
   password_hash TEXT NOT NULL,
   email TEXT,
   account_type TEXT
   );
   CREATE INDEX auth_user ON auth (username);

   CREATE TABLE log (
   id INTEGER PRIMARY KEY,
   user_id INTEGER NOT NULL,
   ticker TEXT NOT NULL,
   operation TEXT NOT NULL,
   price REAL,
   number INTEGER,
   price_total REAL,
   date_time TEXT NOT NULL,
   FOREIGN KEY (user_id) REFERENCES auth (user_id)
   );
   CREATE INDEX log_user ON log (user_id);

   CREATE TABLE listing (
   id INTEGER PRIMARY KEY AUTOINCREMENT,
   secid TEXT NOT NULL,
   secname TEXT COLLATE NOCASE
   );
   CREATE INDEX listing_ticker ON listing (secid);
   CREATE INDEX listing_secname ON listing (secname);

   CREATE TABLE app_log (
   id INTEGER PRIMARY KEY AUTOINCREMENT,
   log_text TEXT NOT NULL,
   date_time TEXT NOT NULL
   );
   ```
   1. `depo`:
      1. `ticker` - тикер ценной бумаги;
      2. `lotsize` - размер лота для торговли (в настоящее время не используется - в дальнейшем планируется реализация торговли дробными лотами);
      3. `name` - наименование ценной бумаги (используется для ajax в поиск/покупка);
      4. `isqualifiedinvestors` - `0-1` (в настоящее время не используется - в дальнейшем планируется разделение на квалифицированных инвесторов и неквалифицированных при регистрации. В то же время статус квалифицированного инвестора в настоящее время не требуется дял торговли акциями и облигациями московской биржи. Понадобится при реализации торговли фьючерсами и опционами);
      5. `initialfacevalue` - номинальная стоимость облигации (стоимость на нее указывается в процентах от номинала);
      6. `number` - количество ценных бумаг у пользователя (в шт.);
      7. `currency` - валюта (сейчас не используется - планируется для анализа портфеля по валютной диверсификации);
      8. `market` - bonds/shares/foreignshares - определяет вид ценной бумаги - облигация, акция, иностранная акция - etf московская биржа относит к акциям;
      9. `min_border` - минимальная граница для уведомления;
      10. `max_border` - максимальная граница для уведомления;
      11. `notification` - `0-1` - уведомлять/нет о выходе стоимости за границы;
      12. `email_sent` - было ли уже отправлено письмо (см. `schedule.py` отправка писем);
   2.  `broker`:
      1. `account` - баланс брокерского счета;
   3. `auth`:
      1. `account_type` - `public` - `private` (см. Работа приложения - регистрация);
   4. `log` - история операций:
      1. `operation` - `sell-buy`
   5. `listing` - список тикеров с московской биржи;
   6. `app_log` - лог приложения.
8. HTML:
   1. Динамически формируются на основе layout.html template с использованием jinja;
   2. Реализован Responsive Web Design для экономии трафика на мобильных устройствах (малый background image) и избежания горизонтальных полос прокрутки на устройствах с малой шириной;
   3. В пользовательских формах для уменьшения нагрузки на сервер и базу данных для каждого `input` реализован тип, максимальные значения, для кнопок купить - продать - активация только при наличии предложений покупки - продажи на бирже.

9. Планы:
   1. Добавить тесты;
   2. Реализация API для удобного взаимодействия с excel, openoffice calc итп;
   3. Реализация торговли фьючерсами и опционами, статуса квалифицированного инвестора;
   4. Реализация push уведомлений;
   5. Использовать исходный код, эмулирующий операции купли/продажи по текущим биржевым ценам для тестирования торговых роботов.
